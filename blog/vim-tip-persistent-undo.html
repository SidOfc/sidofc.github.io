<!DOCTYPE html><html lang="en"><head><script>
                        try {
                            if (localStorage.getItem('dark')) {
                                var html = document.querySelector('html');
                                var style = document.createElement('style');

                                html.setAttribute('class', 'dark')
                                style.innerHTML = 'html { background-color: #111; }';

                                document.head.appendChild(style);
                            }
                        } catch (e) {
                        }
                    </script><meta charSet="utf-8"/><title>Vim tip: persistent undo</title><link rel="cannonical" href="https://sidneyliebrand.io/blog/vim-tip-persistent-undo"/><link rel="manifest" href="/site.webmanifest"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#a676ff"/><link rel="icon" sizes="48x48" type="image/icon" href="/favicon.ico"/><link rel="icon" sizes="16x16" type="image/png" href="/favicon-16x16.png"/><link rel="icon" sizes="32x32" type="image/png" href="/favicon-32x32.png"/><link rel="apple-touch-icon" sizes="180x180" type="image/png" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" title="The official https://sidneyliebrand.io Atom feed" href="/atom.xml"/><link rel="alternate" type="application/rss+xml" title="The official https://sidneyliebrand.io RSS feed" href="/feed.xml"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="theme-color" content="#ffffff"/><meta name="msapplication-TileColor" content="#ffc40d"/><meta name="robots" content="index, follow"/><meta name="author" content="Sidney Liebrand"/><meta name="description" content="Usually, when you open a file in your editor, make some changes, save and close, you lose the ability to &lt;kbd&gt;ctrl&lt;/kbd&gt;+&lt;kbd&gt;Z&lt;/kbd&gt;. Vim has a built in mechanism to persist changes made to files on disk. This may not sound that exciting, but what if your editor crashes while you have a set of changes you may want to revert stored?"/><meta property="og:title" content="Vim tip: persistent undo"/><meta property="og:type" content="website"/><meta property="og:url" content="https://sidneyliebrand.io"/><meta property="og:site_name" content="https://sidneyliebrand.io"/><meta property="og:description" content="Usually, when you open a file in your editor, make some changes, save and close, you lose the ability to &lt;kbd&gt;ctrl&lt;/kbd&gt;+&lt;kbd&gt;Z&lt;/kbd&gt;. Vim has a built in mechanism to persist changes made to files on disk. This may not sound that exciting, but what if your editor crashes while you have a set of changes you may want to revert stored?"/><meta name="dc:creator" content="Sidney Liebrand"/><meta name="dc:title" content="Vim tip: persistent undo"/><meta name="dc:description" content="Usually, when you open a file in your editor, make some changes, save and close, you lose the ability to &lt;kbd&gt;ctrl&lt;/kbd&gt;+&lt;kbd&gt;Z&lt;/kbd&gt;. Vim has a built in mechanism to persist changes made to files on disk. This may not sound that exciting, but what if your editor crashes while you have a set of changes you may want to revert stored?"/><meta name="twitter:card" content="summary"/><meta name="twitter:creator" content="@scbydoooo"/><meta name="next-head-count" content="27"/><link rel="preload" href="/_next/static/css/4812cfb1a2cb9cae132e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4812cfb1a2cb9cae132e.css" data-n-g=""/><link rel="preload" href="/_next/static/css/b5e0e9d6a02f831e9ebf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b5e0e9d6a02f831e9ebf.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-c64519ed79327e51c7fd.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.29f9e2f3d4a33bafbaa5.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.2315b3822f3fa12e695d.js" as="script"/><link rel="preload" href="/_next/static/chunks/62e1beb3a59d93297dd568d6addecfcbe54736d1.1fca791714ca7431afba.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-b5b2d872c8419d5249c6.js" as="script"/><link rel="preload" href="/_next/static/chunks/89c7192737f5dae381690d2d2c3016603346826c.843c937cf181cd6fb50b.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bslug%5D-2cfc249385e7d5375656.js" as="script"/></head><body><div id="__next"><div class="layout_application__6A4un"><header class="layout_header__3bVjw"><div class="layout_headerFixed__3v8Yi"><div class="layout_headerContent__18ocK"><a class="layout_logo__319hZ" title="View home page" href="/"><span class="layout_logoTopLeft__2TXmp"></span><span class="layout_logoBottomLeft__1VwSz"></span><span class="layout_logoTopRight__36KVG"></span><span class="layout_logoBottomRight__34Roq"></span></a><nav class="layout_navigation__19PAD"><a title="View curriculum vitae" href="/cv">C.V.</a><a title="Visit Sidney Liebrand&#x27;s GitHub page" href="https://github.com/SidOfc"><figure class="layout_github__23ZLB media_figure__1BF98 media_invertDark__1FMJX"><div class="lazyload-wrapper "><div style="padding-bottom:100%"></div></div></figure></a><div tabindex="0" title="Toggle dark theme" class="dark-mode-toggle_wrapper__bHDaz"><svg fill="#000000" class="dark-mode-toggle_toggle__2rc2d dark-mode-toggle_toggleDark__2f6wj" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"></path><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"></path></svg><svg fill="#000000" class="dark-mode-toggle_toggle__2rc2d dark-mode-toggle_toggleLight__1OB2p" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"></path><path d="M9.5,2c-1.82,0-3.53,0.5-5,1.35c2.99,1.73,5,4.95,5,8.65s-2.01,6.92-5,8.65C5.97,21.5,7.68,22,9.5,22c5.52,0,10-4.48,10-10 S15.02,2,9.5,2z"></path></svg></div></nav></div></div></header><main class="layout_content__2V5t2"><article class="post_post__2uzyE"><h1 class="heading_container__2UElk"><a class="heading_link__1aoFY" href="/blog/vim-tip-persistent-undo">Vim tip: persistent undo</a></h1><span class="post_postData__yktVb text_page-accent-fg__3pARq">By Sidney Liebrand on <!-- -->Aug, 2018<span class="bullet_bullet__2pnOU">•</span>4<!-- --> min read</span><div><p>Sometimes I happen to close a buffer that I had open for a while and modified here and there.
Then I find out that the code from two or three edits ago in that file actually worked better and I want to revert but upon reopening the file, pressing <code>u</code> shows an <code>Already at oldest change</code> message...</p><p>The second thing I try is <code>git</code> to see the unchanged file but this usually takes me way to far back to be of any use.
This is when I usually realize that I can&#x27;t get back to that point by using any kind of &quot;undo&quot; functionality.</p><p>Finally, the last wall of defense is my brain, small changes from the last edit are usually still lingering in my mind and I can revert them from memory.
Anything large or multi-line, though <!-- -->—<!-- --> forget about it.</p><p>None of the above so far provide a good reliable solution out of the box, but one day while randomly reading through <code>:h undo</code> I found a particularly useful section: <code>:h undo-persistence</code>.</p><h2 class="heading_container__2UElk"><a class="heading_anchor__PWj4r" id="persistent-undo"></a><a class="heading_link__1aoFY" href="#persistent-undo">Persistent undo</a></h2><p>The <code>undo-persistence</code> manual explains that Vim indeed destroys the <em>undo tree </em>when a buffer is <em>unloaded.</em>
To understand exactly what this means, I&#x27;ll give a small explanation.</p><p>In Vim, a buffer is basically a file <em>loaded</em> in memory.
Whenever a file is loaded in memory, Vim keeps track of its <em>undo tree</em> <!-- -->—<!-- --> this is the construct that keeps track of changes and enables one to undo and redo them.
As long as the file remains in memory, the undo tree is kept with it.</p><p>As soon as the buffer is <em>unloaded</em> using for example <code>:[bufnum]bd</code>, it is cleared from memory and the undo tree is destroyed with it.
This is the part that is problematic if you want to revert back to some edit before the last time you re-opened the file in Vim.</p><p>Persistent undo solves this by storing the changes in a file instead of in-memory and linked to the loaded buffer, allowing undo to go back and forth beyond just the set of changes since the file was last opened.
You could go back to yesterday&#x27;s changes or those of two weeks ago for example.</p><h2 class="heading_container__2UElk"><a class="heading_anchor__PWj4r" id="setup"></a><a class="heading_link__1aoFY" href="#setup">Setup</a></h2><p>Fortunately, not much is needed to set this up.
Vim needs a directory to store the persistent undo history and two settings need to be tweaked / enabled.
This is the snippet I have in my Vim config that handles this automatically:</p><pre class="prism-code language-viml" style="background-color:#2a2734;color:#9a86fd"><div class="token-line" style="color:#9a86fd"><span class="token comment" style="color:#9390a1">&quot; guard for distributions lacking the persistent_undo feature.</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">if</span><span class="token plain"> </span><span class="token function" style="color:#fa60c3">has</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token string" style="color:#ffcc99">&#x27;persistent_undo&#x27;</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#9390a1">&quot; define a path to store persistent_undo files.</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">let</span><span class="token plain"> target_path </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token function" style="color:#fa60c3">expand</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token string" style="color:#ffcc99">&#x27;~/.config/vim-persisted-undo/&#x27;</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#9390a1">&quot; create the directory and any parent directories</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#9390a1">&quot; if the location does not exist.</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">if</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">!</span><span class="token function" style="color:#fa60c3">isdirectory</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">target_path</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token keyword" style="color:#ffcc99">call</span><span class="token plain"> </span><span class="token function" style="color:#fa60c3">system</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token string" style="color:#ffcc99">&#x27;mkdir -p &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">.</span><span class="token plain"> target_path</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">endif</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#9390a1">&quot; point Vim to the defined undo directory.</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">let</span><span class="token plain"> &amp;undodir </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> target_path</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#9390a1">&quot; finally, enable undo persistence.</span><span class="token plain"></span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">set</span><span class="token plain"> undofile</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">endif</span></div></pre><p>The above VimL checks if the <code>persistent_undo</code> feature is supported.
Defines a path <code>~/.config/vim-persisted-undo/</code> to store the files.
Creates the directory if it doesn&#x27;t exist and sets the necessary undodir and undofile options.</p><h2 class="heading_container__2UElk"><a class="heading_anchor__PWj4r" id="a-simple-example"></a><a class="heading_link__1aoFY" href="#a-simple-example">A simple example</a></h2><p>Now let&#x27;s go through a simple exercise to see if this works.</p><ol><li>After you&#x27;ve added the snippet or enabled this feature manually, exit Vim and run the following command in the terminal:vim sample.txt.</li><li>Write some text and save the file. Then make another change by adding, removing, or changing the content of the file and save it again.</li><li>The file now has some undo history we can use. Exit Vim and open the file again from the terminal: vim sample.txt.</li><li>Now, pressing u should work as expected and correctly undo the change you made before closing the file.</li></ol><h2 class="heading_container__2UElk"><a class="heading_anchor__PWj4r" id="profit"></a><a class="heading_link__1aoFY" href="#profit">Profit</a></h2><p>That&#x27;s it! You now have access to any edit you made at any point in time for any particular file.
If you accidentally close a buffer, just re-open it and your undo tree will be like it was before closing it.</p><p>I hope that you enjoyed this post and got something useful out of it.
If there is anything I missed I&#x27;d love to hear about it in the comments.
Likewise if I&#x27;m wrong or anything is unclear, I&#x27;ll happily stand corrected.</p><p>Until next time :)</p><p>👋</p></div><a tabindex="0" class="button_button__LVJFE" href="/">Back</a></article></main><footer class="layout_footer__2cV3b"><strong>©</strong> sidneyliebrand.io<!-- --> <!-- -->2021</footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"title":"Vim tip: persistent undo","description":"Usually, when you open a file in your editor, make some changes, save and close, you lose the ability to \u003ckbd\u003ectrl\u003c/kbd\u003e+\u003ckbd\u003eZ\u003c/kbd\u003e. Vim has a built in mechanism to persist changes made to files on disk. This may not sound that exciting, but what if your editor crashes while you have a set of changes you may want to revert stored?","published":"2018-08-04T20:17:52Z","readTimeInMinutes":4,"source":{"compiledSource":"\"use strict\";\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i \u003c arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i \u003c sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) \u003e= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i \u003c sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) \u003e= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar layoutProps = {};\nvar MDXLayout = \"wrapper\";\n\nfunction MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Sometimes I happen to close a buffer that I had open for a while and modified here and there.\\nThen I find out that the code from two or three edits ago in that file actually worked better and I want to revert but upon reopening the file, pressing \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"u\"), \" shows an \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Already at oldest change\"), \" message...\"), mdx(\"p\", null, \"The second thing I try is \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"git\"), \" to see the unchanged file but this usually takes me way to far back to be of any use.\\nThis is when I usually realize that I can't get back to that point by using any kind of \\\"undo\\\" functionality.\"), mdx(\"p\", null, \"Finally, the last wall of defense is my brain, small changes from the last edit are usually still lingering in my mind and I can revert them from memory.\\nAnything large or multi-line, though \", \"\\u2014\", \" forget about it.\"), mdx(\"p\", null, \"None of the above so far provide a good reliable solution out of the box, but one day while randomly reading through \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \":h undo\"), \" I found a particularly useful section: \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \":h undo-persistence\"), \".\"), mdx(\"h2\", null, \"Persistent undo\"), mdx(\"p\", null, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"undo-persistence\"), \" manual explains that Vim indeed destroys the \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"undo tree \"), \"when a buffer is \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"unloaded.\"), \"\\nTo understand exactly what this means, I'll give a small explanation.\"), mdx(\"p\", null, \"In Vim, a buffer is basically a file \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"loaded\"), \" in memory.\\nWhenever a file is loaded in memory, Vim keeps track of its \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"undo tree\"), \" \", \"\\u2014\", \" this is the construct that keeps track of changes and enables one to undo and redo them.\\nAs long as the file remains in memory, the undo tree is kept with it.\"), mdx(\"p\", null, \"As soon as the buffer is \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"unloaded\"), \" using for example \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \":[bufnum]bd\"), \", it is cleared from memory and the undo tree is destroyed with it.\\nThis is the part that is problematic if you want to revert back to some edit before the last time you re-opened the file in Vim.\"), mdx(\"p\", null, \"Persistent undo solves this by storing the changes in a file instead of in-memory and linked to the loaded buffer, allowing undo to go back and forth beyond just the set of changes since the file was last opened.\\nYou could go back to yesterday's changes or those of two weeks ago for example.\"), mdx(\"h2\", null, \"Setup\"), mdx(\"p\", null, \"Fortunately, not much is needed to set this up.\\nVim needs a directory to store the persistent undo history and two settings need to be tweaked / enabled.\\nThis is the snippet I have in my Vim config that handles this automatically:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-viml\"\n  }, \"\\\" guard for distributions lacking the persistent_undo feature.\\nif has('persistent_undo')\\n    \\\" define a path to store persistent_undo files.\\n    let target_path = expand('~/.config/vim-persisted-undo/')\\n\\n    \\\" create the directory and any parent directories\\n    \\\" if the location does not exist.\\n    if !isdirectory(target_path)\\n        call system('mkdir -p ' . target_path)\\n    endif\\n\\n    \\\" point Vim to the defined undo directory.\\n    let \u0026undodir = target_path\\n\\n    \\\" finally, enable undo persistence.\\n    set undofile\\nendif\\n\")), mdx(\"p\", null, \"The above VimL checks if the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"persistent_undo\"), \" feature is supported.\\nDefines a path \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"~/.config/vim-persisted-undo/\"), \" to store the files.\\nCreates the directory if it doesn't exist and sets the necessary undodir and undofile options.\"), mdx(\"h2\", null, \"A simple example\"), mdx(\"p\", null, \"Now let's go through a simple exercise to see if this works.\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"After you've added the snippet or enabled this feature manually, exit Vim and run the following command in the terminal:vim sample.txt.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Write some text and save the file. Then make another change by adding, removing, or changing the content of the file and save it again.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"The file now has some undo history we can use. Exit Vim and open the file again from the terminal: vim sample.txt.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Now, pressing u should work as expected and correctly undo the change you made before closing the file.\")), mdx(\"h2\", null, \"Profit\"), mdx(\"p\", null, \"That's it! You now have access to any edit you made at any point in time for any particular file.\\nIf you accidentally close a buffer, just re-open it and your undo tree will be like it was before closing it.\"), mdx(\"p\", null, \"I hope that you enjoyed this post and got something useful out of it.\\nIf there is anything I missed I'd love to hear about it in the comments.\\nLikewise if I'm wrong or anything is unclear, I'll happily stand corrected.\"), mdx(\"p\", null, \"Until next time :)\"), mdx(\"p\", null, \"\\uD83D\\uDC4B\"));\n}\n\n;\nMDXContent.isMDXComponent = true;","renderedOutput":"\u003cp\u003eSometimes I happen to close a buffer that I had open for a while and modified here and there.\nThen I find out that the code from two or three edits ago in that file actually worked better and I want to revert but upon reopening the file, pressing \u003ccode\u003eu\u003c/code\u003e shows an \u003ccode\u003eAlready at oldest change\u003c/code\u003e message...\u003c/p\u003e\u003cp\u003eThe second thing I try is \u003ccode\u003egit\u003c/code\u003e to see the unchanged file but this usually takes me way to far back to be of any use.\nThis is when I usually realize that I can\u0026#x27;t get back to that point by using any kind of \u0026quot;undo\u0026quot; functionality.\u003c/p\u003e\u003cp\u003eFinally, the last wall of defense is my brain, small changes from the last edit are usually still lingering in my mind and I can revert them from memory.\nAnything large or multi-line, though \u003c!-- --\u003e—\u003c!-- --\u003e forget about it.\u003c/p\u003e\u003cp\u003eNone of the above so far provide a good reliable solution out of the box, but one day while randomly reading through \u003ccode\u003e:h undo\u003c/code\u003e I found a particularly useful section: \u003ccode\u003e:h undo-persistence\u003c/code\u003e.\u003c/p\u003e\u003ch2 class=\"heading_container__2UElk\"\u003e\u003ca class=\"heading_anchor__PWj4r\" id=\"persistent-undo\"\u003e\u003c/a\u003e\u003ca class=\"heading_link__1aoFY\" href=\"#persistent-undo\"\u003ePersistent undo\u003c/a\u003e\u003c/h2\u003e\u003cp\u003eThe \u003ccode\u003eundo-persistence\u003c/code\u003e manual explains that Vim indeed destroys the \u003cem\u003eundo tree \u003c/em\u003ewhen a buffer is \u003cem\u003eunloaded.\u003c/em\u003e\nTo understand exactly what this means, I\u0026#x27;ll give a small explanation.\u003c/p\u003e\u003cp\u003eIn Vim, a buffer is basically a file \u003cem\u003eloaded\u003c/em\u003e in memory.\nWhenever a file is loaded in memory, Vim keeps track of its \u003cem\u003eundo tree\u003c/em\u003e \u003c!-- --\u003e—\u003c!-- --\u003e this is the construct that keeps track of changes and enables one to undo and redo them.\nAs long as the file remains in memory, the undo tree is kept with it.\u003c/p\u003e\u003cp\u003eAs soon as the buffer is \u003cem\u003eunloaded\u003c/em\u003e using for example \u003ccode\u003e:[bufnum]bd\u003c/code\u003e, it is cleared from memory and the undo tree is destroyed with it.\nThis is the part that is problematic if you want to revert back to some edit before the last time you re-opened the file in Vim.\u003c/p\u003e\u003cp\u003ePersistent undo solves this by storing the changes in a file instead of in-memory and linked to the loaded buffer, allowing undo to go back and forth beyond just the set of changes since the file was last opened.\nYou could go back to yesterday\u0026#x27;s changes or those of two weeks ago for example.\u003c/p\u003e\u003ch2 class=\"heading_container__2UElk\"\u003e\u003ca class=\"heading_anchor__PWj4r\" id=\"setup\"\u003e\u003c/a\u003e\u003ca class=\"heading_link__1aoFY\" href=\"#setup\"\u003eSetup\u003c/a\u003e\u003c/h2\u003e\u003cp\u003eFortunately, not much is needed to set this up.\nVim needs a directory to store the persistent undo history and two settings need to be tweaked / enabled.\nThis is the snippet I have in my Vim config that handles this automatically:\u003c/p\u003e\u003cpre class=\"prism-code language-viml\" style=\"background-color:#2a2734;color:#9a86fd\"\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token comment\" style=\"color:#9390a1\"\u003e\u0026quot; guard for distributions lacking the persistent_undo feature.\u003c/span\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003cspan class=\"token keyword\" style=\"color:#ffcc99\"\u003eif\u003c/span\u003e\u003cspan class=\"token plain\"\u003e \u003c/span\u003e\u003cspan class=\"token function\" style=\"color:#fa60c3\"\u003ehas\u003c/span\u003e\u003cspan class=\"token punctuation\" style=\"color:#6c6783\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\" style=\"color:#ffcc99\"\u003e\u0026#x27;persistent_undo\u0026#x27;\u003c/span\u003e\u003cspan class=\"token punctuation\" style=\"color:#6c6783\"\u003e)\u003c/span\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e    \u003c/span\u003e\u003cspan class=\"token comment\" style=\"color:#9390a1\"\u003e\u0026quot; define a path to store persistent_undo files.\u003c/span\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e    \u003c/span\u003e\u003cspan class=\"token keyword\" style=\"color:#ffcc99\"\u003elet\u003c/span\u003e\u003cspan class=\"token plain\"\u003e target_path \u003c/span\u003e\u003cspan class=\"token operator\" style=\"color:#e09142\"\u003e=\u003c/span\u003e\u003cspan class=\"token plain\"\u003e \u003c/span\u003e\u003cspan class=\"token function\" style=\"color:#fa60c3\"\u003eexpand\u003c/span\u003e\u003cspan class=\"token punctuation\" style=\"color:#6c6783\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\" style=\"color:#ffcc99\"\u003e\u0026#x27;~/.config/vim-persisted-undo/\u0026#x27;\u003c/span\u003e\u003cspan class=\"token punctuation\" style=\"color:#6c6783\"\u003e)\u003c/span\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\" style=\"display:inline-block\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e    \u003c/span\u003e\u003cspan class=\"token comment\" style=\"color:#9390a1\"\u003e\u0026quot; create the directory and any parent directories\u003c/span\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e    \u003c/span\u003e\u003cspan class=\"token comment\" style=\"color:#9390a1\"\u003e\u0026quot; if the location does not exist.\u003c/span\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e    \u003c/span\u003e\u003cspan class=\"token keyword\" style=\"color:#ffcc99\"\u003eif\u003c/span\u003e\u003cspan class=\"token plain\"\u003e \u003c/span\u003e\u003cspan class=\"token operator\" style=\"color:#e09142\"\u003e!\u003c/span\u003e\u003cspan class=\"token function\" style=\"color:#fa60c3\"\u003eisdirectory\u003c/span\u003e\u003cspan class=\"token punctuation\" style=\"color:#6c6783\"\u003e(\u003c/span\u003e\u003cspan class=\"token plain\"\u003etarget_path\u003c/span\u003e\u003cspan class=\"token punctuation\" style=\"color:#6c6783\"\u003e)\u003c/span\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e        \u003c/span\u003e\u003cspan class=\"token keyword\" style=\"color:#ffcc99\"\u003ecall\u003c/span\u003e\u003cspan class=\"token plain\"\u003e \u003c/span\u003e\u003cspan class=\"token function\" style=\"color:#fa60c3\"\u003esystem\u003c/span\u003e\u003cspan class=\"token punctuation\" style=\"color:#6c6783\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\" style=\"color:#ffcc99\"\u003e\u0026#x27;mkdir -p \u0026#x27;\u003c/span\u003e\u003cspan class=\"token plain\"\u003e \u003c/span\u003e\u003cspan class=\"token operator\" style=\"color:#e09142\"\u003e.\u003c/span\u003e\u003cspan class=\"token plain\"\u003e target_path\u003c/span\u003e\u003cspan class=\"token punctuation\" style=\"color:#6c6783\"\u003e)\u003c/span\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e    \u003c/span\u003e\u003cspan class=\"token keyword\" style=\"color:#ffcc99\"\u003eendif\u003c/span\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\" style=\"display:inline-block\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e    \u003c/span\u003e\u003cspan class=\"token comment\" style=\"color:#9390a1\"\u003e\u0026quot; point Vim to the defined undo directory.\u003c/span\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e    \u003c/span\u003e\u003cspan class=\"token keyword\" style=\"color:#ffcc99\"\u003elet\u003c/span\u003e\u003cspan class=\"token plain\"\u003e \u0026amp;undodir \u003c/span\u003e\u003cspan class=\"token operator\" style=\"color:#e09142\"\u003e=\u003c/span\u003e\u003cspan class=\"token plain\"\u003e target_path\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\" style=\"display:inline-block\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e    \u003c/span\u003e\u003cspan class=\"token comment\" style=\"color:#9390a1\"\u003e\u0026quot; finally, enable undo persistence.\u003c/span\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e    \u003c/span\u003e\u003cspan class=\"token keyword\" style=\"color:#ffcc99\"\u003eset\u003c/span\u003e\u003cspan class=\"token plain\"\u003e undofile\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"token-line\" style=\"color:#9a86fd\"\u003e\u003cspan class=\"token plain\"\u003e\u003c/span\u003e\u003cspan class=\"token keyword\" style=\"color:#ffcc99\"\u003eendif\u003c/span\u003e\u003c/div\u003e\u003c/pre\u003e\u003cp\u003eThe above VimL checks if the \u003ccode\u003epersistent_undo\u003c/code\u003e feature is supported.\nDefines a path \u003ccode\u003e~/.config/vim-persisted-undo/\u003c/code\u003e to store the files.\nCreates the directory if it doesn\u0026#x27;t exist and sets the necessary undodir and undofile options.\u003c/p\u003e\u003ch2 class=\"heading_container__2UElk\"\u003e\u003ca class=\"heading_anchor__PWj4r\" id=\"a-simple-example\"\u003e\u003c/a\u003e\u003ca class=\"heading_link__1aoFY\" href=\"#a-simple-example\"\u003eA simple example\u003c/a\u003e\u003c/h2\u003e\u003cp\u003eNow let\u0026#x27;s go through a simple exercise to see if this works.\u003c/p\u003e\u003col\u003e\u003cli\u003eAfter you\u0026#x27;ve added the snippet or enabled this feature manually, exit Vim and run the following command in the terminal:vim sample.txt.\u003c/li\u003e\u003cli\u003eWrite some text and save the file. Then make another change by adding, removing, or changing the content of the file and save it again.\u003c/li\u003e\u003cli\u003eThe file now has some undo history we can use. Exit Vim and open the file again from the terminal: vim sample.txt.\u003c/li\u003e\u003cli\u003eNow, pressing u should work as expected and correctly undo the change you made before closing the file.\u003c/li\u003e\u003c/ol\u003e\u003ch2 class=\"heading_container__2UElk\"\u003e\u003ca class=\"heading_anchor__PWj4r\" id=\"profit\"\u003e\u003c/a\u003e\u003ca class=\"heading_link__1aoFY\" href=\"#profit\"\u003eProfit\u003c/a\u003e\u003c/h2\u003e\u003cp\u003eThat\u0026#x27;s it! You now have access to any edit you made at any point in time for any particular file.\nIf you accidentally close a buffer, just re-open it and your undo tree will be like it was before closing it.\u003c/p\u003e\u003cp\u003eI hope that you enjoyed this post and got something useful out of it.\nIf there is anything I missed I\u0026#x27;d love to hear about it in the comments.\nLikewise if I\u0026#x27;m wrong or anything is unclear, I\u0026#x27;ll happily stand corrected.\u003c/p\u003e\u003cp\u003eUntil next time :)\u003c/p\u003e\u003cp\u003e👋\u003c/p\u003e","scope":{"title":"Vim tip: persistent undo","description":"Usually, when you open a file in your editor, make some changes, save and close, you lose the ability to \u003ckbd\u003ectrl\u003c/kbd\u003e+\u003ckbd\u003eZ\u003c/kbd\u003e. Vim has a built in mechanism to persist changes made to files on disk. This may not sound that exciting, but what if your editor crashes while you have a set of changes you may want to revert stored?","published":"2018-08-04T20:17:52Z"}},"slug":"vim-tip-persistent-undo"},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"vim-tip-persistent-undo"},"buildId":"Iki42CZDSSe-sZbOPLbbo","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-ff94e68042added27a93.js"></script><script src="/_next/static/chunks/main-c64519ed79327e51c7fd.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.29f9e2f3d4a33bafbaa5.js" async=""></script><script src="/_next/static/chunks/commons.2315b3822f3fa12e695d.js" async=""></script><script src="/_next/static/chunks/62e1beb3a59d93297dd568d6addecfcbe54736d1.1fca791714ca7431afba.js" async=""></script><script src="/_next/static/chunks/pages/_app-b5b2d872c8419d5249c6.js" async=""></script><script src="/_next/static/chunks/89c7192737f5dae381690d2d2c3016603346826c.843c937cf181cd6fb50b.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-2cfc249385e7d5375656.js" async=""></script><script src="/_next/static/Iki42CZDSSe-sZbOPLbbo/_buildManifest.js" async=""></script><script src="/_next/static/Iki42CZDSSe-sZbOPLbbo/_ssgManifest.js" async=""></script></body></html>